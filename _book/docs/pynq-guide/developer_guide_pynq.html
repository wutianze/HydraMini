
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>For Developer Â· HydraMini Guide</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Sauron Wu">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../host-guide/preprocess_train.html" />
    
    
    <link rel="prev" href="run_guide.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Pynq Part</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="collect_guide.html">
            
                <a href="collect_guide.html">
            
                    
                    Collect Data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="run_guide.html">
            
                <a href="run_guide.html">
            
                    
                    Run the Car
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.3" data-path="developer_guide_pynq.html">
            
                <a href="developer_guide_pynq.html">
            
                    
                    For Developer
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Host Part</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../host-guide/preprocess_train.html">
            
                <a href="../host-guide/preprocess_train.html">
            
                    
                    Preprocess & Train
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../host-guide/quantize_compile.html">
            
                <a href="../host-guide/quantize_compile.html">
            
                    
                    Quantize & Compile
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Virtual Part</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../virtual-guide/">
            
                <a href="../virtual-guide/">
            
                    
                    Preparation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../virtual-guide/custom_simulator.html">
            
                <a href="../virtual-guide/custom_simulator.html">
            
                    
                    Custom Simulator
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../more-study/ros.html">
            
                <a href="../more-study/ros.html">
            
                    
                    ROS
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >For Developer</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <!--
 * @Author: Sauron Wu
 * @GitHub: wutianze
 * @Email: 1369130123qq@gmail.com
 * @Date: 2019-12-24 15:55:57
 * @LastEditors  : Sauron Wu
 * @LastEditTime : 2019-12-24 16:02:28
 * @Description: How to set the hardware value.
 -->
<h1 id="guide-for-developer">Guide For Developer</h1>
<p>Show you the detail of HydraMini in Pynq-Part including keyboard control, motor value set and DPU c++ library usage.</p>
<h1 id="define-your-own-controller">Define your own controller</h1>
<h2 id="1-modify-the-labels-you-want-to-save">1. Modify the labels you want to save</h2>
<p>In <code>src/control.h&amp;control.cc</code>, you can see the current controller class PYNQZ2, the function <code>to_record</code> will return a string which will be written as labels. PYNQZ2 controller will store the throttle value and steer value of the car currently. You can replace the function content by your own to store other information.<br><strong><em>Tip: The label file&apos;s format is csv which means values should be separated by &apos;,&apos;</em></strong></p>
<h2 id="2-modify-the-keyboard-settings">2. Modify the keyboard settings</h2>
<p>You can choose a more comfortable way to play the car. The function you need to change in this part is in <code>collect.cc/main</code>. You will see a <code>switch(c)</code> in <code>main</code>, read the code and I&apos;m sure you can define your own settings quickly.  </p>
<h1 id="pynq-control-api">Pynq-Control API</h1>
<ol>
<li>void throttleSet(float)<br>Set the throttle value of the car. The value range from -1.0 to 1.0. 0 means stop, &gt; 0.0 means forward and &lt; 0.0 means backward. The third led will be lighted.</li>
<li>void steerSet(float)<br>Set the steer value of the car. The value range from -1.0 to 1.0. 0 means straight forward, &gt; 0.0 means right and &lt; 0.0 means left. The fourth led will be lighted.</li>
<li>void throttleChange(float)<br>Add to the throttle value of the car. The max of input value is 1.0 and the min is -1.0. The first and third leds will be lighted.</li>
<li>void steerChange(float)<br>Add to the steer value of the car. The max of input value is 1.0 and the min is -1.0. The second and fourth leds will be lighted.</li>
<li>PYNQZ2::Status<em> getStatus()<br>Return the current Status of the car. It contains the current throttle and steer value of the car. You can use it like `PYNQZ2::Status</em> s = controller.getStatus(); float nowThrottle = s-&gt;throttleRate; float nowSteer = s-&gt;steerRate;`</li>
<li>string to_record()<br>This function can generate a piece of info describing the current status of the car in .csv format. Example return: <code>0.1,0.5</code>, 0.1 is the steer value and 0.5 is the throttle value. It seems that the car is moving right forward now.</li>
</ol>
<h1 id="motor-value-set">Motor Value Set</h1>
<ol>
<li>If you want to change the max speed value or max steer value, you can edit <code>src/control.cc</code>, see the codes below which shows the init value and zero(medium) value of the motors. You can change the zero value to make sure the motor doesn&apos;t move or the car runs straight; change the <code>THROTTLEVAL/STEERVAL</code> to make the car runs faster or makes a bigger turning. <pre><code class="lang-c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> THROTTLEINIT 500000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> THROTTLEVAL 60000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> THROTTLEZERO 140000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STEERINIT 2000000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STEERVAL 40000</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STEERZERO 151000</span>
</code></pre>
</li>
<li>Remember to run <code>make collect/run</code> to compile.</li>
</ol>
<h1 id="dpu-c-library-libn2cube-usage">DPU c++ library libn2cube usage:</h1>
<ul>
<li>Library libn2cube is the DNNDK core library. It implements the functionality of DPU loader, and encapsulates the system calls to invoke the DPU driver for DPU Task scheduling, monitoring, profiling, and resources management. </li>
<li><p>Simple guide of libn2cube</p>
<ol>
<li>The information you need to know after the generation of .elf using the host part of DNNDK-v3.0(If you don&apos;t know what it is, please refer to the Host part guide of this project) is:<ul>
<li>kernel name: KERNEL_CONV</li>
<li>input node(s): CONV_INPUT_NODE</li>
<li>output node(s): CONV_OUTPUT_NODE  </li>
</ul>
</li>
<li>Each DPU kernel supported by the DPU has a corresponding ELF object file with a name that is the same as the kernel name prefixed by dpu_ with extension .elf. So before compiling your code, you should put the .elf files into model directory and add their names to MODEL variable in Makefile.  </li>
<li><p>The sample flow of using DPU kernel:  </p>
<pre><code class="lang-c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
<span class="hljs-comment">/* DPU Kernels/Tasks for running ResNet-50 */</span>
DPUKernel* kernelConv;
DPUTask* taskConv
<span class="hljs-comment">/* Attach to DPU driver and prepare for running */</span>
dpuOpen()
<span class="hljs-comment">/* Create DPU Kernels for CONV Nodes */</span>
kernelConv = dpuLoadKernel(KERNEL_CONV)
<span class="hljs-comment">/* Create DPU Tasks for CONV Nodes*/</span>
taskConv = dpuCreateTask(kernelConv, <span class="hljs-number">0</span>)
<span class="hljs-comment">/* Run CONV Kernel*/</span>
Mat image = imread(baseImagePath + imageName);
dpuSetInputImage2(taskConv, CONV_INPUT_NODE, image);
dpuRunTask(taskConv)
<span class="hljs-comment">/* Get inference result */</span>
<span class="hljs-keyword">float</span> scale = dpuGetOutputTensorScale(taskConv, CONV_OUTPUT_NODE);
<span class="hljs-comment">/* modelRes is the start address of the model&apos;s output */</span>
<span class="hljs-keyword">int8_t</span>* modelRes = dpuGetTensorAddress(dpuGetOutputTensor(taskConv, CONV_OUTPUT_NODE));
<span class="hljs-comment">/* the true value should * scale */</span>
<span class="hljs-keyword">float</span> result1 = modelRes[<span class="hljs-number">0</span>] * scale;

<span class="hljs-comment">/* Destroy DPU Tasks &amp; release resources */</span>
dpuDestroyTask(taskConv)
<span class="hljs-comment">/* Destroy DPU Kernel &amp; release resources */</span>
dpuDestroyKernel(kernelConv)
<span class="hljs-comment">/* Detach DPU driver &amp; release resources */</span>
dpuClose();
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
</code></pre>
</li>
<li>The <code>main()</code> operations include:<ul>
<li>Call <code>dpuOpen()</code> to open the DPU device.</li>
<li>Call <code>dpuLoadKernel()</code> to load the DPU kernel reset50_0.</li>
<li>Call <code>dpuCreateTask()</code> to create task for each DPU kernel.</li>
<li>Call <code>dpuDestroyKernel()</code> and <code>dpuDestroyTask()</code> to destroy DPU kernel and task.</li>
<li>Call <code>dpuClose()</code> to close the DPU device.</li>
</ul>
</li>
<li>Run CONV Kernel include:<ul>
<li>Get the image for processing and set it as input</li>
<li>Run the task using <code>dpuRunTask()</code></li>
<li>Get the output of the kernel and Run Softmax in it if needed</li>
<li>If your model is regression model, you can just use the result without running softmax like  <pre><code class="lang-c++"><span class="hljs-keyword">float</span>* res = <span class="hljs-keyword">float</span>*(smRes.data()); <span class="hljs-keyword">float</span> final_res = res[<span class="hljs-number">0</span>] + res[<span class="hljs-number">1</span>]
</code></pre>
</li>
</ul>
</li>
</ol>
</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="run_guide.html" class="navigation navigation-prev " aria-label="Previous page: Run the Car">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../host-guide/preprocess_train.html" class="navigation navigation-next " aria-label="Next page: Preprocess & Train">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"For Developer","level":"2.3","depth":1,"next":{"title":"Preprocess & Train","level":"3.1","depth":1,"path":"docs/host-guide/preprocess_train.md","ref":"docs/host-guide/preprocess_train.md","articles":[]},"previous":{"title":"Run the Car","level":"2.2","depth":1,"path":"docs/pynq-guide/run_guide.md","ref":"docs/pynq-guide/run_guide.md","articles":[]},"dir":"ltr"},"config":{"plugins":["livereload"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Sauron Wu","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"HydraMini Guide","gitbook":"*","description":"The guide of HydraMini, an affordable platform for autonomous driving research and education"},"file":{"path":"docs/pynq-guide/developer_guide_pynq.md","mtime":"2020-02-17T11:26:36.967Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-02-17T11:43:30.522Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

